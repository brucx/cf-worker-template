# 测试场景文档

## 1. 任务管理测试场景

### 1.1 任务创建测试

#### 场景1: 正常任务创建
- **前置条件**: 用户已认证，有有效JWT令牌
- **测试步骤**:
  1. 发送POST请求到 `/api/task`
  2. 包含有效的任务请求体
- **预期结果**: 
  - 返回201状态码
  - 返回任务ID
  - 任务状态为WAITING
  - 任务保存到D1数据库

#### 场景2: 无效请求体
- **前置条件**: 用户已认证
- **测试步骤**:
  1. 发送POST请求，缺少必需字段
  2. 发送POST请求，字段类型错误
- **预期结果**: 
  - 返回400状态码
  - 错误信息描述验证失败

#### 场景3: 未认证请求
- **前置条件**: 无JWT令牌或令牌无效
- **测试步骤**: 发送POST请求到 `/api/task`
- **预期结果**: 返回401状态码

### 1.2 任务查询测试

#### 场景4: 查询存在的任务
- **前置条件**: 任务已存在
- **测试步骤**: GET `/api/task/{taskId}`
- **预期结果**: 返回任务详情

#### 场景5: 查询不存在的任务
- **测试步骤**: GET `/api/task/nonexistent-id`
- **预期结果**: 返回404状态码

### 1.3 任务更新测试

#### 场景6: 更新任务状态
- **前置条件**: 任务存在且为PROCESSING状态
- **测试步骤**: PUT `/api/task/{taskId}` 更新为FINISHED
- **预期结果**: 
  - 任务状态更新
  - 数据库记录更新
  - updatedAt时间戳更新

#### 场景7: 并发更新冲突
- **测试步骤**: 两个请求同时更新同一任务
- **预期结果**: 确保数据一致性，无竞态条件

## 2. 服务器管理测试场景

### 2.1 服务器注册测试

#### 场景8: 注册新服务器
- **前置条件**: Admin角色用户
- **测试步骤**: POST `/api/servers` 
- **预期结果**: 
  - 服务器添加到注册表
  - ServerInstance DO创建
  - 开始健康检查

#### 场景9: 重复注册相同ID
- **测试步骤**: 使用相同ID注册两次
- **预期结果**: 第二次注册覆盖第一次或返回错误

#### 场景10: 非Admin用户注册
- **前置条件**: 普通用户JWT
- **测试步骤**: POST `/api/servers`
- **预期结果**: 返回403禁止访问

### 2.2 健康检查测试

#### 场景11: 健康服务器检查
- **前置条件**: 服务器health端点返回200
- **测试步骤**: 等待健康检查触发
- **预期结果**: 
  - 服务器状态为ONLINE
  - lastHeartbeat更新

#### 场景12: 不健康服务器检查
- **前置条件**: health端点返回500或超时
- **测试步骤**: 等待健康检查
- **预期结果**: 
  - 服务器状态为OFFLINE
  - 记录lastOfflineTime

#### 场景13: 长期离线自动移除
- **前置条件**: 服务器离线超过3分钟
- **测试步骤**: 等待清理触发
- **预期结果**: 服务器从注册表移除

#### 场景14: 健康检查重试机制
- **前置条件**: health端点间歇性失败
- **测试步骤**: 触发健康检查
- **预期结果**: 重试3次后才标记为离线

### 2.3 服务器查询测试

#### 场景15: 获取服务器列表
- **测试步骤**: GET `/api/servers`
- **预期结果**: 返回所有注册服务器

#### 场景16: 获取单个服务器详情
- **测试步骤**: GET `/api/servers/{serverId}`
- **预期结果**: 返回服务器元数据和状态

### 2.4 服务器删除测试

#### 场景17: 手动删除服务器
- **前置条件**: Admin用户，服务器存在
- **测试步骤**: DELETE `/api/servers/{serverId}`
- **预期结果**: 
  - 服务器从注册表移除
  - ServerInstance DO清理

#### 场景18: 删除不存在的服务器
- **测试步骤**: DELETE不存在的服务器ID
- **预期结果**: 返回404

## 3. 任务执行测试场景

### 3.1 任务分配测试

#### 场景19: 分配到可用服务器
- **前置条件**: 有ONLINE服务器
- **测试步骤**: 创建新任务
- **预期结果**: 任务分配到健康服务器

#### 场景20: 无可用服务器
- **前置条件**: 所有服务器OFFLINE
- **测试步骤**: 创建新任务
- **预期结果**: 任务保持WAITING状态

#### 场景21: 服务器选择算法
- **前置条件**: 多个ONLINE服务器
- **测试步骤**: 创建多个任务
- **预期结果**: 任务均匀分配

### 3.2 任务处理测试

#### 场景22: 同步处理成功
- **前置条件**: 服务器async=false
- **测试步骤**: 任务发送到predict端点
- **预期结果**: 
  - 收到结果
  - 任务状态FINISHED
  - 结果保存到数据库

#### 场景23: 异步处理成功
- **前置条件**: 服务器async=true
- **测试步骤**: 
  1. 任务发送到predict端点
  2. 通过回调接收结果
- **预期结果**: 
  - 初始状态PROCESSING
  - 回调后状态FINISHED

#### 场景24: 处理失败重试
- **前置条件**: predict端点返回错误
- **测试步骤**: 任务执行失败
- **预期结果**: 
  - 自动重试（最多3次）
  - 最终标记为FAILED

#### 场景25: 处理超时
- **前置条件**: predict请求超时
- **测试步骤**: 等待超时触发
- **预期结果**: 
  - 任务标记为FAILED
  - 错误信息包含超时详情

## 4. 认证与授权测试

### 4.1 JWT认证测试

#### 场景26: 有效JWT令牌
- **测试步骤**: 使用有效JWT访问API
- **预期结果**: 请求成功处理

#### 场景27: 过期JWT令牌
- **测试步骤**: 使用过期JWT访问API
- **预期结果**: 返回401

#### 场景28: 签名无效的JWT
- **测试步骤**: 使用错误密钥签名的JWT
- **预期结果**: 返回401

### 4.2 角色授权测试

#### 场景29: Admin角色访问
- **前置条件**: JWT包含admin角色
- **测试步骤**: 访问服务器管理端点
- **预期结果**: 访问成功

#### 场景30: 普通用户访问受限端点
- **前置条件**: JWT不包含admin角色
- **测试步骤**: 访问 `/api/servers`
- **预期结果**: 返回403

## 5. 并发与性能测试

### 5.1 并发任务创建

#### 场景31: 大量并发任务
- **测试步骤**: 同时创建100个任务
- **预期结果**: 
  - 所有任务成功创建
  - 无数据竞争
  - 响应时间合理

### 5.2 Durable Object并发

#### 场景32: ServerRegistry并发访问
- **测试步骤**: 多个请求同时更新注册表
- **预期结果**: 数据一致性保持

#### 场景33: TaskManager并发更新
- **测试步骤**: 并发更新同一任务
- **预期结果**: 状态转换正确

## 6. 故障恢复测试

### 6.1 服务中断恢复

#### 场景34: Durable Object重启
- **测试步骤**: 模拟DO重启
- **预期结果**: 
  - 状态从存储恢复
  - 继续正常操作

#### 场景35: 数据库连接失败
- **测试步骤**: D1数据库暂时不可用
- **预期结果**: 
  - 错误正确处理
  - 不影响其他操作

### 6.2 网络故障

#### 场景36: 健康检查网络超时
- **测试步骤**: health端点网络延迟
- **预期结果**: 超时后标记离线

#### 场景37: Predict端点连接失败
- **测试步骤**: 后端服务器不可达
- **预期结果**: 任务标记失败，尝试其他服务器

## 7. 数据一致性测试

### 7.1 状态一致性

#### 场景38: DO存储与数据库同步
- **测试步骤**: 验证任务状态
- **预期结果**: DO状态与D1数据库一致

#### 场景39: 注册表持久化
- **测试步骤**: 重启后验证服务器列表
- **预期结果**: 服务器列表正确恢复

### 7.2 事务完整性

#### 场景40: 部分失败回滚
- **测试步骤**: 任务更新中途失败
- **预期结果**: 状态回滚到之前的一致状态

## 8. 边界条件测试

### 8.1 资源限制

#### 场景41: 大型任务负载
- **测试步骤**: 发送超大请求体
- **预期结果**: 请求被拒绝或正确处理

#### 场景42: 服务器注册表容量
- **测试步骤**: 注册1000个服务器
- **预期结果**: 性能保持可接受

### 8.2 时间边界

#### 场景43: 时钟偏差处理
- **测试步骤**: 服务器时间不同步
- **预期结果**: 健康检查容忍小偏差

#### 场景44: 长时间运行任务
- **测试步骤**: 任务运行超过1小时
- **预期结果**: 正确处理或超时

## 9. 安全测试

### 9.1 输入验证

#### 场景45: SQL注入测试
- **测试步骤**: 任务ID包含SQL语句
- **预期结果**: 输入被清理，无注入

#### 场景46: XSS攻击测试
- **测试步骤**: 任务数据包含脚本
- **预期结果**: 脚本被转义

### 9.2 SSRF防护

#### 场景47: 恶意URL测试
- **测试步骤**: 注册内网地址服务器
- **预期结果**: URL验证失败

#### 场景48: URL重定向测试
- **测试步骤**: health端点重定向
- **预期结果**: 不跟随不安全重定向

## 10. API文档与监控测试

### 10.1 OpenAPI文档

#### 场景49: 文档生成
- **测试步骤**: 访问 `/docs`
- **预期结果**: 返回完整API文档

#### 场景50: 文档准确性
- **测试步骤**: 验证文档与实际API一致
- **预期结果**: 所有端点正确记录

### 10.2 日志与监控

#### 场景51: 错误日志记录
- **测试步骤**: 触发各种错误
- **预期结果**: 错误正确记录

#### 场景52: 性能指标收集
- **测试步骤**: 执行操作
- **预期结果**: 指标被收集（如果实现）

## 测试执行策略

### 单元测试
- 覆盖各个组件的独立功能
- 模拟外部依赖
- 快速执行，频繁运行

### 集成测试
- 测试组件间交互
- 使用测试环境
- 验证端到端流程

### 性能测试
- 负载测试：正常负载下的表现
- 压力测试：极限负载下的表现
- 持久性测试：长时间运行稳定性

### 安全测试
- 渗透测试
- 漏洞扫描
- 合规性检查

## 测试环境要求

1. **本地开发环境**
   - Wrangler dev server
   - 本地D1数据库
   - 模拟后端服务器

2. **测试环境**
   - 独立的Cloudflare Workers部署
   - 测试D1数据库实例
   - 测试后端服务器

3. **生产前环境**
   - 与生产相同配置
   - 真实后端服务器
   - 性能监控工具

## 测试数据准备

### 基础测试数据
```json
{
  "validTask": {
    "mimeType": "application/json",
    "model": "test-model",
    "video_quality": "high",
    "video_url": "https://example.com/video.mp4",
    "enable_upscale": true
  },
  "validServer": {
    "id": "test-server-001",
    "endpoints": {
      "predict": "https://backend.example.com/predict",
      "health": "https://backend.example.com/health"
    },
    "provider": "test-provider",
    "name": "Test Server",
    "async": false,
    "callback": true
  },
  "adminJWT": "eyJ...",
  "userJWT": "eyJ..."
}
```

## 测试报告模板

### 测试执行摘要
- 总测试用例数
- 通过/失败/跳过数
- 覆盖率百分比
- 执行时间

### 失败详情
- 失败场景编号
- 失败原因
- 堆栈跟踪
- 重现步骤

### 性能指标
- 平均响应时间
- 95th百分位延迟
- 吞吐量（req/s）
- 错误率

### 建议改进
- 发现的问题
- 优先级分类
- 修复建议